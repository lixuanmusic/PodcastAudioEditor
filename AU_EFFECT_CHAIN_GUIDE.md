# AU 效果器链系统 - 快速入门指南

## 🎯 功能概述

已成功实现了一个完整的 **4 个插槽 AU 效果器链系统**，集成在主编辑器界面中。用户可以：

1. **加载 AU 效果器** - 从系统中选择并加载任何 AU 音效插件
2. **实时听效** - 在播放音频时立即听到效果器的处理效果
3. **管理效果器** - 启用/禁用/编辑每个效果器
4. **精确控制** - 通过 seek 功能在任意位置精确定位并继续播放

## 📍 界面位置

### 效果器链面板位置
在主编辑器界面的**底部**，分为两个区域：

```
┌─────────────────────────────────────┐
│  播放控制 / 时间显示 / 音量控制     │
├─────────────────────────────────────┤
│  波形显示区域                       │
├─────────────────────────────────────┤
│  📊 音频优化 (导出功能)             │  ← AudioProcessingPanel
├─────────────────────────────────────┤
│  🔌 AU 效果器链 (4 个插槽)          │  ← EffectSlotsPanel (新!)
├─────────────────────────────────────┤
│  水平滚动条                         │
└─────────────────────────────────────┘
```

## 🚀 使用步骤

### 1. 导入音频文件

```
点击"导入"按钮 → 选择音频文件 → 确认
```

### 2. 加载效果器到插槽

每个插槽（插槽 0-3）都有三个按钮：

| 按钮 | 图标 | 功能 |
|------|------|------|
| 选择 | ➕ | 打开效果器选择对话框 |
| 编辑 | 🎚️ | 编辑效果器参数（如果支持） |
| 移除 | ❌ | 卸载当前效果器 |

**步骤：**
```
1. 点击插槽上的 "➕" 按钮
2. 在对话框中选择需要的效果器
3. 点击"加载"
4. 效果器立即在信号链中激活
```

### 3. 启用/禁用效果器

- 每个插槽右上角有一个**开关**
- 启用：效果器处理音频
- 禁用：音频直接通过，不处理

### 4. 编辑效果器参数

某些效果器支持参数编辑：
```
1. 点击插槽上的 "🎚️" 按钮
2. 在弹出窗口中调整参数（如果支持）
3. 参数立即生效，实时听到效果变化
```

### 5. 播放和 Seek

- **播放**: 点击播放按钮或按 `Space`
- **Seek**: 直接点击波形图上的任意位置
- **效果器会在新位置继续处理音频**

## 🎛️ 信号流向

```
音频文件
  ↓
PlayerNode (播放节点)
  ↓
[插槽 0] → [插槽 1] → [插槽 2] → [插槽 3]
  ↓                                    ↓
  ←──────────── 串联 ────────────────→
  ↓
MainMixer (主混音器)
  ↓
扬声器 (实时播放)
```

## 📦 常用 AU 效果器类型

系统支持 macOS 中的所有 AU 效果器，包括：

### 🔊 动态处理
- **AUCompressor** - 压缩器（控制动态范围）
- **AUPeakLimiter** - 峰值限幅器（防止过载）

### 🎵 EQ 和滤波
- **AUParametricEQ** - 参数均衡器
- **AUBandPass** - 带通滤波器
- **AUFilter** - 通用滤波器

### 🎚️ 空间效果
- **AUReverbG2** - 混响（创建空间感）
- **AUDelay** - 延迟（回声效果）
- **AUConvolver** - 卷积混响（用脉冲响应创建混响）

### 💡 使用建议

**推荐效果器组合：**

1. **清晰增强**
   ```
   插槽 0: AUParametricEQ (提升高频)
   插槽 1: AUCompressor (平衡动态)
   插槽 2: AUPeakLimiter (安全保护)
   ```

2. **空间增强**
   ```
   插槽 0: AUDelay (增加深度)
   插槽 1: AUReverbG2 (空间感)
   ```

3. **完整处理链**
   ```
   插槽 0: AUCompressor (控制)
   插槽 1: AUParametricEQ (EQ)
   插槽 2: AUDelay (深度)
   插槽 3: AUReverbG2 (空间)
   ```

## ⚡ 关键特性

### ✅ 实时处理
- 效果器在播放时立即生效
- 参数变化实时可听

### ✅ Seek 支持
- 通过 `scheduleSegment` 实现精确帧级定位
- seek 后效果器继续正确处理

### ✅ 灵活启用/禁用
- 单个插槽可独立启用/禁用
- 整个效果链可禁用（通过右上角开关）

### ✅ 4 个串联插槽
- 支持复杂的处理流程
- 可创建多层次的音频处理效果

### ✅ 参数编辑
- 某些效果器支持原生 AU 参数界面
- 实时听到参数变化的效果

## 🔧 技术细节

### 架构升级
从 `AVAudioPlayer` 升级到 `AVAudioEngine + AVAudioPlayerNode`：
- **为什么**: AVAudioPlayer 不支持 AU 效果器链
- **好处**: 完整的节点图系统，支持复杂音频处理

### Seek 实现
使用 `scheduleSegment` 而非 `currentTime` 设置：
```swift
playerNode.scheduleSegment(audioFile,
                          startingFrame: startFrame,
                          frameCount: totalFrames,
                          at: nil)
```

这确保了：
- ✅ 精确的帧级定位
- ✅ 避免内存拷贝
- ✅ 效果器链正常处理

## 📁 文件结构

```
Audio/
├── AudioUnitEffectSlot.swift     # 单个效果器插槽管理
├── AudioEffectChain.swift        # 效果器链管理器（4个插槽）
├── AudioUnitLoader.swift         # AU 发现和加载工具
└── AudioEngine.swift             # 升级版播放引擎

Views/
├── EffectSlotsPanel.swift        # 完整的效果器 UI 面板
└── MainEditorView.swift          # 集成效果器链的主编辑器
```

## 🐛 故障排除

### 效果器选择对话框为空
- 系统中可能没有安装 AU 效果器
- 尝试安装第三方 AU 插件

### 效果器加载失败
- 某些第三方 AU 可能与系统不兼容
- 尝试使用 Apple 提供的原生 AU

### 声音断裂或噪音
- 减少效果器数量或复杂度
- 检查 CPU 占用情况

## 🎓 下一步

1. **导出支持**: 将 AU 效果器应用到导出的音频文件
2. **预设系统**: 保存和加载效果器配置
3. **自动化**: 参数随时间变化的自动化

---

**构建状态**: ✅ BUILD SUCCEEDED

现在可以在应用中看到完整的 AU 效果器链面板，并在实时播放时使用效果器处理音频！
