# 动态音量平衡功能使用指南

## 功能概述

动态音量平衡是一项智能音频处理功能，它能自动检测和补偿音频中的音量差异。通过分析音频的声学特征（如RMS能量），系统会生成一条增益包络曲线，动态调整每个时间点的音量，使整个音频的响度更加均匀一致。

## 核心特性

### 1. 智能增益计算
- **目标RMS**：-14dB（业界标准的平衡点）
- **增益范围**：-12dB 到 +12dB
- **处理流程**：
  - 从音频分析特征中提取RMS能量
  - 计算原始增益（目标RMS - 当前能量）
  - 应用平滑滤波（中值滤波 + 移动平均）
  - 应用包络跟踪（快速攻击、缓慢释放）
  - 限制增益在允许范围内

### 2. 平滑增益曲线
系统采用三层滤波策略确保增益曲线平滑：
- **中值滤波**（3帧窗口）：移除尖峰噪声
- **移动平均**（5帧窗口）：平滑增益变化
- **包络跟踪**：
  - 攻击时间：0.05秒（快速响应音量增加）
  - 释放时间：0.2秒（缓慢恢复，避免突变）

### 3. 实时应用
- 播放时：每帧自动查询对应的增益值，实时应用于AUPeakLimiter的Pre-Gain参数
- 导出时：使用相同的增益包络进行离线处理

## 使用流程

### 第一步：分析音频
1. 打开或拖拽一个音频文件到应用
2. 点击波形区域右上方的 **"分析"** 按钮（波形圆形图标）
3. 等待分析完成（显示进度条，完成后显示绿色"✓ 分析完成"提示）

### 第二步：启用动态音量平衡
1. 点击控制栏上的 **"动态音量平衡"** 按钮（放大镜波形图标）
2. 系统会自动：
   - 计算增益包络曲线
   - 在波形区下方显示增益曲线可视化
   - 将AUPeakLimiter效果器自动加载到插槽1
   - 按钮变为填充状态，表示功能已启用

### 第三步：播放和调整
- **播放**：点击播放按钮，系统会实时应用增益包络
- **查看增益曲线**：波形区下方的"增益包络"面板显示了每个时刻的增益值
  - 绿色线条：增益包络曲线
  - 白色竖线：当前播放位置
  - 中心线：0dB（无增益）
  - 上下范围：-12dB 到 +12dB
- **缩放和滚动**：增益曲线与波形完全同步，支持缩放和水平滚动

### 第四步：导出处理后的音频
1. 确保已启用动态音量平衡
2. 点击控制栏的 **"导出"** 按钮（上箭头图标）
3. 选择保存位置和文件名
4. 系统会：
   - 使用当前的增益包络进行处理
   - 对每个采样点应用对应的增益
   - 防止削波（限制在-1.0到1.0范围内）
   - 导出为M4A格式

## 技术细节

### 数据结构

#### AcousticFeatures（音频分析特征）
```swift
struct AcousticFeatures {
    var timestamp: Double      // 时间戳（秒）
    var energy: Float          // RMS能量（dB）
    var zcr: Float            // 零交叉率
    var spectralCentroid: Float // 频谱质心
    var mfccValues: [Float]    // MFCC系数（13维）
    var isVoiced: Bool         // 是否为有声音
}
```

#### GainEnvelopeData（增益包络数据）
```swift
struct GainEnvelopeData {
    let timestamps: [Double]    // 时间戳数组
    let gains: [Float]          // 增益值数组（dB）
    let energyValues: [Float]   // 原始能量值
    var frameCount: Int         // 总帧数
    var durationSeconds: Double // 总时长
}
```

### 关键类和方法

#### GainEnvelopeCalculator
- **calculateGainEnvelope(from:)**：从音频特征计算增益包络
  - 输入：`[AcousticFeatures]`
  - 输出：`[Float]`（dB）
  - 处理时间：通常 <1秒

#### DynamicVolumeBalanceViewModel
- **calculateGainEnvelope(from:)**：计算增益并自动加载AUPeakLimiter
- **getGainAtTime(_:)**：获取指定时刻的增益值
- **loadAUPeakLimiterToSlot1()**：自动加载效果器到插槽1
- **reset()**：重置所有数据

#### GainEnvelopeCurveView
- Canvas-based可视化视图
- 实时绘制增益曲线和播放进度线
- 与波形视图完全同步（缩放、滚动、宽度）

#### AudioEngine
- **applyDynamicGain(_:)**：实时更新AUPeakLimiter的Pre-Gain参数
  - 搜索对应的参数（pregain/pre-gain/input）
  - 限制增益范围：-96 到 24 dB
  - 立即应用参数更新

## 参数说明

### GainEnvelopeCalculator配置

| 参数 | 值 | 说明 |
|------|-----|------|
| targetRMS | -14.0 dB | 目标RMS电平 |
| minGain | -12.0 dB | 最小增益（降低上限） |
| maxGain | 12.0 dB | 最大增益（提升上限） |
| smoothingWindowSize | 5 | 移动平均窗口大小（帧数） |
| attackTime | 0.05 s | 攻击时间（快速响应） |
| releaseTime | 0.2 s | 释放时间（缓慢恢复） |

### 音频处理参数

| 参数 | 值 | 说明 |
|------|-----|------|
| hopSize | 768 | 帧跳跃大小（采样点） |
| frameSize | 1024 | 帧大小（采样点） |
| sampleRate | 44100 Hz | 采样率（固定） |

## 工作流程图

```
┌─────────────────────────────────────────────────────┐
│ 1. 加载音频文件                                      │
└──────────────┬──────────────────────────────────────┘
              │
              ↓
┌─────────────────────────────────────────────────────┐
│ 2. 点击分析按钮                                      │
│    - 提取音频特征（MFCC、RMS、FFT等）               │
│    - 显示分析进度                                    │
└──────────────┬──────────────────────────────────────┘
              │
              ↓
┌─────────────────────────────────────────────────────┐
│ 3. 点击动态音量平衡按钮                              │
│    - 计算增益包络曲线                                │
│    - 自动加载AUPeakLimiter到插槽1                   │
│    - 显示增益曲线可视化                              │
└──────────────┬──────────────────────────────────────┘
              │
        ┌─────┴──────┐
        ↓            ↓
    ┌─────────┐  ┌─────────┐
    │ 播放    │  │ 导出    │
    └────┬────┘  └────┬────┘
         │            │
         ↓            ↓
    ┌────────────────────────┐
    │ 实时应用增益包络       │
    │ (Pre-Gain参数)        │
    └────────────────────────┘
```

## 可视化说明

### 增益曲线视图（GainEnvelopeCurveView）

```
      增益 (dB)
         ↑
     12  │  ╱╲
      6  │ ╱  ╲
      0  │─────●─────  ← 当前播放位置
     -6  │ ╱╲╲╱
    -12  │╱╲╱╱╲
         └─────────→ 时间
```

- **网格线**：显示-12dB、-6dB、0dB、+6dB、+12dB刻度
- **绿色曲线**：增益包络曲线（自上而下表示衰减）
- **浅绿填充**：曲线下方的视觉反馈
- **白色竖线**：当前播放时刻
- **同步滚动**：与波形视图完全对齐

## 故障排除

### 问题1：未看到增益曲线
- 确认已点击分析按钮并完成分析
- 确认已点击动态音量平衡按钮
- 检查波形区下方是否出现"增益包络"标签

### 问题2：增益包络未生效
- 检查AUPeakLimiter是否已加载到插槽1（UI中插槽1应显示为"AUPeakLimiter"）
- 检查控制台日志中是否有错误信息
- 尝试关闭并重新启用动态音量平衡

### 问题3：导出后声音没有变化
- 确保在导出前已启用动态音量平衡
- 检查导出过程中的控制台日志："使用动态增益包络进行导出"
- 确认原始音频文件确实存在音量差异

## 性能优化

### 计算效率
- 增益包络计算通常 <1秒（取决于音频长度）
- 采样间隔优化避免过度绘制增益曲线
- 二分查找实现O(log n)的时刻查询

### 内存管理
- 增益数组仅存储Frame-level数据（通常 <10KB）
- Canvas绘制采样避免绘制每一个数据点
- 及时释放音频缓冲区

### 实时应用
- 参数更新频率与播放帧率一致
- 使用高效的Audio Unit参数设置API
- 避免频繁的内存分配

## 示例代码

### 获取指定时刻的增益值
```swift
if let gain = dynamicVolumeVM.getGainAtTime(currentTime) {
    audioEngine.applyDynamicGain(gain)
}
```

### 计算增益包络
```swift
dynamicVolumeVM.calculateGainEnvelope(from: analysisVM.features)
// 自动加载AUPeakLimiter并应用增益包络
```

### 获取时间范围内的增益
```swift
let gains = dynamicVolumeVM.getGainsInTimeRange(
    startTime: 0.0,
    endTime: 10.0
)
```

## 参考资源

- **Audio Unit (AU)**：macOS原生音频效果器框架
- **AUPeakLimiter**：Apple官方的峰值限制器效果器
- **MFCC**：梅尔频率倒谱系数，用于语音特征提取
- **RMS**：均方根能量，用于响度测量

## 更新日志

### v1.0 (2025-11-05)
- 首次发布动态音量平衡功能
- 实现增益包络计算和实时应用
- 添加可视化曲线显示
- 支持播放和导出应用增益
