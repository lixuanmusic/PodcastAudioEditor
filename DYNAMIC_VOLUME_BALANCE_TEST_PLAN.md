# 动态音量平衡功能测试计划

## 测试目标
验证动态音量平衡功能的所有组件能正确协作，包括：
1. 增益包络计算的正确性
2. UI交互的流畅性
3. 实时增益应用的有效性
4. 导出功能的完整性

## 测试前提条件
- PodcastAudioEditor应用已构建并运行
- 准备一份测试音频文件（推荐：包含音量差异的播客或对话录音）
- 应用已在Debug配置下运行，可查看控制台日志

## 测试场景

### 测试1：基础工作流
**目标**：验证从加载到应用增益的完整流程

**步骤**：
1. 打开或拖拽一个音频文件到应用
2. 确认波形显示正确
3. 点击"分析"按钮（波形圆形图标）
4. 等待分析完成
5. 观察控制台输出

**预期结果**：
- [ ] 波形正确显示
- [ ] 分析进度条出现
- [ ] 分析完成时出现"✓ 分析完成"绿色提示
- [ ] 控制台输出类似日志：
  ```
  🎚️  开始计算增益包络: [N]帧
  ✅ 增益包络计算完成: [X.XXX]秒
  📊 增益范围: [min, max] dB
  ```

**验证方法**：
- 检查波形显示
- 观察Toast提示
- 查看控制台日志

---

### 测试2：动态音量平衡启用
**目标**：验证增益包络计算和可视化显示

**步骤**：
1. 确保已完成测试1的分析
2. 点击"动态音量平衡"按钮（放大镜波形图标）
3. 等待增益包络计算完成
4. 观察UI变化

**预期结果**：
- [ ] 按钮变为填充状态（表示启用）
- [ ] 波形区下方出现"增益包络"面板
- [ ] 增益曲线以绿色线条显示
- [ ] 曲线高度范围：-12dB ~ +12dB
- [ ] 中心线标记0dB
- [ ] 控制台输出：
  ```
  ✅ 动态音量平衡: 增益包络已生成，共[N]个增益点
  ✅ AUPeakLimiter 已自动加载到插槽1
  ```

**验证方法**：
- 观察UI按钮状态变化
- 验证增益曲线的显示
- 查看插槽1是否显示"AUPeakLimiter"
- 检查控制台日志

---

### 测试3：增益曲线同步
**目标**：验证增益曲线与波形的同步

**步骤**：
1. 确保已启用动态音量平衡
2. 使用鼠标滚轮在波形区进行缩放
3. 观察增益曲线是否同步缩放
4. 拖拽滚动条进行水平滚动
5. 观察增益曲线是否同步滚动

**预期结果**：
- [ ] 缩放波形时，增益曲线等比缩放
- [ ] 滚动波形时，增益曲线同步移动
- [ ] 曲线始终对齐到波形下方
- [ ] 白色播放进度线在两个视图中位置一致

**验证方法**：
- 视觉验证：曲线与波形的对齐
- 观察缩放和滚动时的同步效果

---

### 测试4：实时播放应用
**目标**：验证播放时实时更新增益

**步骤**：
1. 确保已启用动态音量平衡
2. 点击播放按钮
3. 观察白色播放进度线的移动
4. 监听音频输出变化
5. 观察AUPeakLimiter的参数是否变化

**预期结果**：
- [ ] 播放进度线平滑移动
- [ ] 增益曲线中的进度线位置与波形一致
- [ ] AUPeakLimiter的Pre-Gain参数实时更新
  - 可通过点击插槽1查看参数值变化
  - 参数值应在-12 ~ +12 dB范围内变化
- [ ] 音频输出响度相对均匀（相比未应用增益时）

**验证方法**：
- 观察进度线同步性
- 监听音频变化
- 检查AUPeakLimiter参数编辑器中的数值变化
- 对比启用前后的音量差异

---

### 测试5：增益曲线信息准确性
**目标**：验证增益值在合理范围内

**步骤**：
1. 确保已启用动态音量平衡
2. 观察增益曲线的形状和幅度
3. 在不同位置验证增益值范围

**预期结果**：
- [ ] 增益曲线不超过±12dB范围
- [ ] 曲线形状反映音频的能量变化
  - 高能量部分应显示负增益（降低）
  - 低能量部分应显示正增益（提升）
- [ ] 曲线应平滑，无明显尖峰

**验证方法**：
- 视觉观察曲线幅度
- 验证曲线与原始能量的反向关系
- 检查平滑度（应无锯齿状）

---

### 测试6：导出功能
**目标**：验证导出时正确应用增益包络

**步骤**：
1. 确保已启用动态音量平衡
2. 点击"导出"按钮（上箭头图标）
3. 选择保存位置，输入文件名
4. 等待导出完成
5. 查看导出的音频文件

**预期结果**：
- [ ] 导出按钮处于启用状态
- [ ] 保存对话框正确打开
- [ ] 导出过程显示进度（如需）
- [ ] 完成后显示"✓ 导出成功！"提示
- [ ] 控制台输出：
  ```
  📊 使用动态增益包络进行导出: [N]个增益点
  ✓ 音频处理完成
  ```
- [ ] 导出文件大小合理（通常略大于原文件，因为可能包含更多细节）
- [ ] 导出文件可在其他音频播放器中正常播放
- [ ] 导出后的音频响度相对均匀

**验证方法**：
- 检查导出进度和完成提示
- 查看控制台日志
- 用外部播放器验证导出文件
- 对比原始文件和导出文件的音量一致性

---

### 测试7：降级方案验证
**目标**：验证未启用动态音量平衡时的导出

**步骤**：
1. 不启用动态音量平衡
2. 直接点击"导出"按钮
3. 完成导出

**预期结果**：
- [ ] 导出使用原始增益计算（AudioProcessor.calculateVolumeGains）
- [ ] 控制台输出：
  ```
  📊 使用原始增益计算进行导出: [N]个增益点
  ```
- [ ] 导出完成

**验证方法**：
- 检查控制台输出内容
- 验证导出文件可正常播放

---

### 测试8：边界情况处理
**目标**：验证异常情况的处理

**步骤**：
1. **空文件处理**：
   - 不加载任何文件直接点击分析
   - 预期：分析按钮禁用或不执行

2. **多次分析**：
   - 多次点击分析按钮
   - 预期：进度条覆盖，正确处理

3. **切换文件**：
   - 加载文件A，分析
   - 拖拽加载文件B
   - 预期：清除旧的分析结果，重新分析

**预期结果**：
- [ ] 所有边界情况正确处理
- [ ] 无崩溃或异常消息
- [ ] UI状态正确反应

**验证方法**：
- 观察UI行为
- 检查控制台是否有错误日志

---

## 控制台日志关键字检查表

| 关键字 | 模块 | 说明 |
|--------|------|------|
| `🎚️  开始计算增益包络` | GainEnvelopeCalculator | 增益计算开始 |
| `✅ 增益包络计算完成` | GainEnvelopeCalculator | 计算完成 |
| `📊 增益范围` | GainEnvelopeCalculator | 增益范围统计 |
| `✅ 动态音量平衡: 增益包络已生成` | DynamicVolumeBalanceViewModel | 包络生成完成 |
| `✅ AUPeakLimiter 已自动加载到插槽1` | DynamicVolumeBalanceViewModel | 效果器加载成功 |
| `📊 使用动态增益包络进行导出` | MainEditorView | 导出使用动态增益 |
| `📊 使用原始增益计算进行导出` | MainEditorView | 导出使用降级方案 |
| `✓ 音频处理完成` | AudioProcessor | 导出完成 |

---

## 性能指标

| 指标 | 预期值 | 备注 |
|------|--------|------|
| 增益包络计算时间 | <1秒 | 根据音频长度 |
| UI响应延迟 | <100ms | 操作后的反馈时间 |
| 导出速度 | 实时或更快 | 取决于文件大小 |
| 内存占用增长 | <50MB | 相对基准应用 |

---

## 常见问题和解决方案

### Q: 为什么分析按钮禁用？
**A**: 检查是否已加载音频文件

### Q: 为什么增益曲线不显示？
**A**: 确认已点击动态音量平衡按钮，且分析已完成

### Q: 为什么导出后声音未变化？
**A**:
- 确认已启用动态音量平衡
- 检查原始音频是否有明显的音量差异
- 尝试使用具有更大音量差异的音频

### Q: 控制台显示错误如何解决？
**A**: 检查具体错误信息，查看本文档的故障排除部分

---

## 测试记录模板

```
测试日期：[YYYY-MM-DD]
测试者：[名称]
音频文件：[文件名]
构建版本：[版本号]

| 测试项 | 结果 | 备注 |
|--------|------|------|
| 测试1 | ☐ 通过 ☐ 失败 | |
| 测试2 | ☐ 通过 ☐ 失败 | |
| 测试3 | ☐ 通过 ☐ 失败 | |
| 测试4 | ☐ 通过 ☐ 失败 | |
| 测试5 | ☐ 通过 ☐ 失败 | |
| 测试6 | ☐ 通过 ☐ 失败 | |
| 测试7 | ☐ 通过 ☐ 失败 | |
| 测试8 | ☐ 通过 ☐ 失败 | |

总体结果：☐ 全部通过 ☐ 部分失败

失败项详情：
[描述任何失败的测试和相应的错误信息]

性能指标：
- 增益计算时间：[X.XXX]秒
- 导出时间：[X.XXX]秒
- 内存占用：[X]MB

额外备注：
[任何额外的观察或建议]
```

---

## 结论标准

**功能完整**：所有8个测试场景全部通过
**功能基本完整**：7个场景通过，1个轻微问题
**功能需改进**：<7个场景通过
